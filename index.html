<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Eterium / FingerCloak Lab</title>
  <meta name="color-scheme" content="dark">
  <style>
    :root{
      --bg:#07090f;
      --panel:#0c1322;
      --panel-2:#0e1628;
      --text:#dff2ff;
      --muted:#8fa7b7;
      --accent:#38e8ff;
      --accent-2:#c43cff;
      --good:#0bd27a;
      --bad:#ff4769;
      --warn:#ffc14d;
      --radius:16px;
      --shadow:0 0 24px #0ff3 inset, 0 0 24px #000;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -20%, #11203a 0, transparent 60%),
        radial-gradient(1000px 500px at 110% 10%, #2a1144 0, transparent 60%),
        linear-gradient(180deg, #05070c, #07090f 30%, #060a13);
      background-attachment: fixed;
    }
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    header{
      display:flex; align-items:center; gap:16px; margin-bottom:20px;
    }
    .logo{
      width:42px;height:42px; border-radius:10px;
      background: conic-gradient(from 120deg, var(--accent), var(--accent-2), #0ff, var(--accent));
      filter: blur(0.2px) saturate(1.2);
      box-shadow:0 0 24px #00f5ff66;
    }
    h1{margin:0;font-weight:800;letter-spacing:.4px}
    .sub{color:var(--muted); margin-top:2px}
    .grid{display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(320px,1fr));}
    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid #2a4058aa;
      border-radius:var(--radius);
      padding:16px;
      position:relative;
      box-shadow: 0 0 0 1px #0a1724 inset, 0 30px 60px #0008;
      overflow:hidden;
    }
    .card::after{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(200px 80px at 20% -10%, #3afcff22, transparent 60%);
      pointer-events:none;
    }
    .card h2{margin:0 0 12px 0; font-size:18px; font-weight:700; letter-spacing:.3px}
    .row{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px}
    button{
      border:1px solid #2a4058; background:#0a1220; color:var(--text);
      padding:8px 12px; border-radius:10px; cursor:pointer; font-family:var(--sans);
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
    }
    button:hover{ border-color:#4cd1ff; box-shadow:0 0 0 2px #1a2a3e inset }
    button:active{ transform:scale(.98) }
    .btn-accent{ background:linear-gradient(90deg,#0b2236,#0f2743); border-color:#3fd6ff }
    .meta{font:12px var(--mono); color:var(--muted)}
    pre{
      margin:0;
      font:12px/1.45 var(--mono);
      background:#0b1020;
      color:#e8f0ff;
      padding:12px;
      border-radius:12px;
      border:1px solid #1c2c42;
      max-height:320px; overflow:auto;
    }
    .kv{display:grid; grid-template-columns: 180px 1fr; gap:8px 14px; font:13px var(--mono)}
    .dim{color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:4px 8px; border-radius:999px; font:12px var(--mono);
      border:1px solid #2a4058; background:#0a1220;
    }
    .ok{color:var(--good); border-color:#0bd27a66}
    .bad{color:var(--bad); border-color:#ff476966}
    .warn{color:var(--warn); border-color:#ffc14d66}
    .footer{margin:24px 0 60px; color:#9bb3c4; font-size:13px}
    .hr{height:1px; background:linear-gradient(90deg, transparent, #375573, transparent); margin:12px 0}
    .muted{color:var(--muted)}
    .tiny{font-size:11px}
    .blink{animation: pulse 1.2s infinite}
    @keyframes pulse {0%{opacity:.55} 50%{opacity:1} 100%{opacity:.55}}
    .copy-done{color:var(--good)}
    details{border:1px dashed #2a405866; border-radius:10px; padding:10px}
    details[open]{border-style:solid}
    summary{cursor:pointer; color:#a9dfff; margin:-10px; padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Eterium / <span style="color:var(--accent)">FingerCloak</span> Lab</h1>
        <div class="sub">Показываем, что сайт может узнать о вас прямо сейчас — локально, без установки.</div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Статус</h2>
        <div class="row">
          <span id="api-pill" class="pill warn"><span class="blink">●</span> API /ping…</span>
          <span id="rtc-pill" class="pill"><span>●</span> WebRTC не запускался</span>
          <span id="canvas-pill" class="pill"><span>●</span> Canvas не запускался</span>
        </div>
        <div class="kv">
          <div class="dim">Страница</div><div id="page-url"></div>
          <div class="dim">Время</div><div id="now"></div>
          <div class="dim">IP (WebRTC)</div><div id="ip-rtc" class="muted">скрыто / требуется запуск теста</div>
        </div>
        <div class="hr"></div>
        <div class="row">
          <button id="btn-copy" class="btn-accent">Скопировать полный отчёт</button>
          <span id="copy-state" class="tiny muted">в буфере обмена будет JSON с результатами</span>
        </div>
      </section>

      <section class="card">
        <h2>Окружение браузера</h2>
        <div class="kv" id="kv-basic">
          <!-- наполняется JS -->
        </div>
        <div class="hr"></div>
        <details>
          <summary>Сырой JSON (UA, UA-CH, языки, таймзона…)</summary>
          <pre id="env-pre">loading…</pre>
        </details>
      </section>

      <section class="card">
        <h2>Экран и хранилища</h2>
        <div class="kv" id="kv-screen"></div>
        <div class="hr"></div>
        <div class="kv" id="kv-storage"></div>
      </section>

      <section class="card">
        <h2>WebGL / GPU</h2>
        <div class="kv" id="kv-webgl"></div>
        <div class="hr"></div>
        <details>
          <summary>Сырой JSON WebGL</summary>
          <pre id="webgl-pre">—</pre>
        </details>
      </section>

      <section class="card">
        <h2>Canvas fingerprint</h2>
        <div class="row">
          <button id="btn-canvas">Запустить Canvas-хэш</button>
          <span class="tiny muted">рисуем в оффскрине и считаем SHA-256</span>
        </div>
        <div class="kv">
          <div class="dim">Хэш</div><div id="canvas-hash" class="muted">—</div>
          <div class="dim">Размер</div><div id="canvas-size" class="muted">—</div>
        </div>
      </section>

      <section class="card">
        <h2>WebRTC</h2>
        <div class="row">
          <button id="btn-rtc">Проверить ICE-кандидаты (IP-утечки)</button>
          <span class="tiny muted">используется публичный STUN Google; выполняется только по клику</span>
        </div>
        <div class="kv">
          <div class="dim">Найдено кандидатов</div><div id="rtc-count" class="muted">0</div>
          <div class="dim">Приватные адреса</div><div id="rtc-private" class="muted">—</div>
          <div class="dim">Публичные адреса</div><div id="rtc-public" class="muted">—</div>
          <div class="dim">Типы</div><div id="rtc-types" class="muted">—</div>
        </div>
        <div class="hr"></div>
        <details>
          <summary>Сырые строки candidates</summary>
          <pre id="rtc-pre">—</pre>
        </details>
      </section>

      <section class="card">
        <h2>Разрешения и сигналы приватности</h2>
        <div class="kv" id="kv-perms"></div>
      </section>

      <section class="card">
        <h2>API / Ping</h2>
        <div class="kv">
          <div class="dim">Endpoint</div><div>https://eterium-api.onrender.com/ping</div>
          <div class="dim">Результат</div><div id="api-pre" class="muted">…</div>
        </div>
      </section>
    </div>

    <div class="footer">
      © <span id="year"></span> Eterium / FingerCloak Lab. Данные показываются локально в вашем браузере; мы их никуда не отправляем.
    </div>
  </div>

<script>
  // ---------- helpers ----------
  const $ = (id)=>document.getElementById(id);
  const fmtBytes = (n)=> n==null ? '—' :
    (n>1e9? (n/1e9).toFixed(2)+' GB':
     n>1e6? (n/1e6).toFixed(2)+' MB':
     n>1e3? (n/1e3).toFixed(2)+' KB': n+' B');
  const ts = ()=> new Date().toISOString().replace('T',' ').replace('Z',' UTC');

  const state = {
    env:{}, screen:{}, storage:{}, webgl:{}, canvas:{}, rtc:{ raw:[], public:[], private:[], types:[] },
    perms:{}, api:{}, meta:{}
  };

  function setPill(id, cls, text){
    const el = $(id);
    el.className = `pill ${cls||''}`.trim();
    el.innerHTML = `<span>●</span> ${text}`;
  }

  function kvFill(containerId, obj){
    const el = $(containerId);
    el.innerHTML = '';
    for(const [k,v] of Object.entries(obj)){
      const dv = document.createElement('div'); dv.className='dim'; dv.textContent = k;
      const dd = document.createElement('div'); dd.textContent = (typeof v==='object' && v!==null) ? JSON.stringify(v) : String(v);
      el.append(dv,dd);
    }
  }

  async function sha256Hex(str){
    const buf = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', buf);
    return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  // ---------- ENV ----------
  async function collectEnv(){
    const ua = navigator.userAgent;
    let uaData = null;
    try{
      if (navigator.userAgentData?.getHighEntropyValues){
        uaData = await navigator.userAgentData.getHighEntropyValues([
          "architecture","bitness","platform","platformVersion","uaFullVersion","fullVersionList","model","mobile"
        ]);
      }
    }catch(e){ uaData = { error: String(e) }; }

    state.env = {
      ua,
      uaData,
      languages: navigator.languages,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      platform: navigator.platform,
      hardwareConcurrency: navigator.hardwareConcurrency ?? null,
      deviceMemory: navigator.deviceMemory ?? null,
      doNotTrack: navigator.doNotTrack ?? null,
      cookiesEnabled: navigator.cookieEnabled ?? null,
      userAgent: ua, // дублируем для отчёта
    };

    $("env-pre").textContent = JSON.stringify(state.env, null, 2);

    kvFill("kv-basic",{
      "UA": ua.slice(0,140)+(ua.length>140?'…':''),
      "UA platform": state.env.uaData?.platform ?? navigator.platform ?? '—',
      "UA version": state.env.uaData?.uaFullVersion ?? '—',
      "Mobile": state.env.uaData?.mobile ?? false,
      "Languages": state.env.languages?.join(', ') ?? '—',
      "Timezone": state.env.timezone ?? '—',
      "Hardware threads": state.env.hardwareConcurrency ?? '—',
      "Device memory (GB)": state.env.deviceMemory ?? '—',
      "Do Not Track": state.env.doNotTrack ?? '—',
      "Cookies enabled": state.env.cookiesEnabled ?? '—'
    });
  }

  // ---------- Screen & Storage ----------
  async function collectScreen(){
    const dpr = window.devicePixelRatio || 1;
    const s = {
      "Screen": `${screen.width}×${screen.height}`,
      "Avail": `${screen.availWidth}×${screen.availHeight}`,
      "Inner": `${innerWidth}×${innerHeight}`,
      "Color depth": screen.colorDepth,
      "Pixel ratio": dpr,
      "Touch points": navigator.maxTouchPoints ?? 0
    };
    state.screen = s;
    kvFill("kv-screen", s);

    let est = {};
    try{
      if (navigator.storage?.estimate){
        const {usage, quota} = await navigator.storage.estimate();
        est = {
          "Storage usage": fmtBytes(usage),
          "Storage quota": fmtBytes(quota),
        };
      } else {
        est = {"Storage": "нет API estimate"};
      }
    }catch(e){ est = {"Storage error": String(e)}; }
    state.storage = est;
    kvFill("kv-storage", est);
  }

  // ---------- WebGL ----------
  function collectWebGL(){
    const c = document.createElement('canvas');
    const gl = c.getContext('webgl') || c.getContext('experimental-webgl');
    if(!gl){ state.webgl = { supported:false }; kvFill("kv-webgl", {"WebGL": "not supported"}); $("webgl-pre").textContent='—'; return; }

    const dbg = gl.getExtension('WEBGL_debug_renderer_info');
    const vendor = dbg ? gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL) : gl.getParameter(gl.VENDOR);
    const renderer = dbg ? gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL) : gl.getParameter(gl.RENDERER);

    const params = {
      vendor, renderer,
      antialias: gl.getContextAttributes().antialias,
      version: gl.getParameter(gl.VERSION),
      shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
      maxTextureSize: gl.getParameter(gl.MAX_TEXTURE_SIZE),
      maxRenderbufferSize: gl.getParameter(gl.MAX_RENDERBUFFER_SIZE),
      maxVertexAttribs: gl.getParameter(gl.MAX_VERTEX_ATTRIBS),
      maxCombinedTextureImageUnits: gl.getParameter(gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),
      supportedExtensions: (gl.getSupportedExtensions()||[]).slice(0,25)
    };
    state.webgl = params;
    kvFill("kv-webgl", {
      "Vendor": vendor, "Renderer": renderer,
      "GL version": params.version,
      "GLSL": params.shadingLanguageVersion,
      "Max texture": params.maxTextureSize,
      "Max attribs": params.maxVertexAttribs,
      "Ext (first 25)": params.supportedExtensions.length
    });
    $("webgl-pre").textContent = JSON.stringify(params, null, 2);
  }

  // ---------- Canvas ----------
  async function runCanvas(){
    try{
      const size = {w:2400, h:600}; // стабильный большой холст
      const cnv = new OffscreenCanvas(size.w, size.h);
      const ctx = cnv.getContext('2d');

      // рендерим разные примитивы
      ctx.fillStyle = "#0b1020"; ctx.fillRect(0,0,size.w,size.h);
      ctx.fillStyle = "#39e9ff"; ctx.font = "48px 'Segoe UI', Tahoma, sans-serif";
      ctx.fillText("FingerCloak ✦ canvas fp", 30, 80);
      ctx.strokeStyle = "#c43cff"; ctx.lineWidth = 3;
      ctx.beginPath(); ctx.arc(360,160,70,0,Math.PI*2); ctx.stroke();
      const grd = ctx.createLinearGradient(0,0,400,0); grd.addColorStop(0,"#39e9ff"); grd.addColorStop(1,"#c43cff");
      ctx.fillStyle=grd; ctx.fillRect(30,120,420,60);

      // немного композитинга
      ctx.globalCompositeOperation = "multiply";
      ctx.fillStyle = "#ffd54a";
      ctx.fillRect(60,150,260,80);
      ctx.globalCompositeOperation = "source-over";

      // текст с разными параметрами
      ctx.fillStyle = "#e8f0ff"; ctx.font = "28px Georgia, serif";
      ctx.fillText("ΔΣπ glyphs: ẞЖЙשم漢字 — AaBb", 30, 240);

      // конвертируем в dataURL и хэшируем
      const blob = await cnv.convertToBlob({type:"image/png", quality:1});
      const arr = await blob.arrayBuffer();
      const hash = await crypto.subtle.digest('SHA-256', arr);
      const hex = [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join('');

      state.canvas = { hash:hex, size };
      $("canvas-hash").textContent = hex;
      $("canvas-size").textContent = `${size.w}×${size.h}`;
      setPill('canvas-pill','ok', 'Canvas выполнен');
    }catch(e){
      $("canvas-hash").textContent = "Ошибка: "+e;
      setPill('canvas-pill','bad', 'Canvas ошибка');
    }
  }

  // ---------- WebRTC ----------
  function isPrivateIP(ip){
    // RFC1918 + link-local
    return /^(10\.|192\.168\.|172\.(1[6-9]|2\d|3[0-1])\.|169\.254\.)/.test(ip);
  }

  async function runRTC(){
    setPill('rtc-pill','warn','WebRTC запускается…');
    const rtcLines=[];
    const pub=new Set(), priv=new Set(), types=new Set();
    let pc;
    try{
      pc = new RTCPeerConnection({ iceServers:[{urls:'stun:stun.l.google.com:19302'}] });
      pc.createDataChannel('fc'); // чтобы шёл ICE-gathering
      pc.onicecandidate = (ev)=>{
        if(!ev.candidate) return;
        const s = ev.candidate.candidate;
        rtcLines.push(s);
        const m = s.match(/candidate:\S+ \d+ \w+ (\d+\.\d+\.\d+\.\d+) (\d+) typ (\w+)/);
        if(m){
          const ip = m[1], typ = m[3];
          (isPrivateIP(ip)?priv:pub).add(ip);
          types.add(typ);
        }
        $("rtc-pre").textContent = rtcLines.join("\n");
        $("rtc-count").textContent = rtcLines.length;
        $("rtc-private").textContent = priv.size? [...priv].join(", ") : "нет";
        $("rtc-public").textContent = pub.size? [...pub].join(", ") : "нет";
        $("rtc-types").textContent = types.size? [...types].join(", ") : "—";
        $("ip-rtc").textContent = [...pub, ...priv][0] || "—";
      };
      const offer = await pc.createOffer({offerToReceiveAudio:false, offerToReceiveVideo:false});
      await pc.setLocalDescription(offer);

      // ждём завершения сбора кандидатов (таймаут ~2.5s)
      await new Promise(r=>{
        const t = setTimeout(r, 2500);
        pc.onicegatheringstatechange = ()=>{ if (pc.iceGatheringState === 'complete'){ clearTimeout(t); r(); } };
      });

      setPill('rtc-pill', pub.size ? 'warn' : 'ok', pub.size ? 'WebRTC: обнаружен публичный IP' : 'WebRTC: публичный IP не найден');
    }catch(e){
      $("rtc-pre").textContent = "Ошибка: "+e;
      setPill('rtc-pill','bad','WebRTC ошибка');
    }finally{
      try{ pc && pc.close(); }catch(_){}
      state.rtc = { raw:rtcLines, public:[...pub], private:[...priv], types:[...types] };
    }
  }

  // ---------- Permissions ----------
  async function collectPerms(){
    const out = {};
    const list = [
      'geolocation','notifications','camera','microphone','persistent-storage','background-sync','clipboard-read','clipboard-write'
    ];
    for (const name of list){
      try{
        if (!navigator.permissions?.query){ out[name] = 'no API'; continue; }
        const st = await navigator.permissions.query({name});
        out[name] = st.state;
      }catch(_){ out[name] = 'unknown'; }
    }
    // network info
    const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (conn){
      out['network.effectiveType'] = conn.effectiveType;
      out['network.downlink'] = conn.downlink;
      out['network.rtt'] = conn.rtt;
      out['network.saveData'] = conn.saveData;
    }
    state.perms = out;
    kvFill("kv-perms", out);
  }

  // ---------- API ping ----------
  async function pingAPI(){
    try{
      const r = await fetch("https://eterium-api.onrender.com/ping", {mode:'cors'});
      const j = await r.json();
      state.api = j;
      $("api-pre").textContent = JSON.stringify(j);
      setPill('api-pill','ok','API /ping OK');
    }catch(e){
      $("api-pre").textContent = "Ошибка: "+e;
      setPill('api-pill','bad','API /ping ошибка');
    }
  }

  // ---------- Copy report ----------
  async function copyReport(){
    const report = {
      meta: { when: ts(), page: location.href },
      env: state.env, screen: state.screen, storage: state.storage,
      webgl: state.webgl, canvas: state.canvas, rtc: state.rtc,
      perms: state.perms, api: state.api
    };
    const text = JSON.stringify(report, null, 2);
    try{
      await navigator.clipboard.writeText(text);
      $("copy-state").textContent = "скопировано";
      $("copy-state").classList.add('copy-done');
      setTimeout(()=>{ $("copy-state").textContent="в буфере обмена будет JSON с результатами"; $("copy-state").classList.remove('copy-done'); }, 2500);
    }catch(e){
      $("copy-state").textContent = "ошибка копирования: "+e;
    }
  }

  // ---------- boot ----------
  (async function boot(){
    $("year").textContent = new Date().getFullYear();
    $("page-url").textContent = location.href;
    $("now").textContent = ts();

    await collectEnv();
    await collectScreen();
    collectWebGL();
    await collectPerms();
    await pingAPI();

    $("btn-canvas").addEventListener('click', runCanvas);
    $("btn-rtc").addEventListener('click', runRTC);
    $("btn-copy").addEventListener('click', copyReport);
  })();
</script>
</body>
</html>
